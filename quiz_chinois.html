<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Quiz chinois</title>
<style>
        body {
        font-family: sans-serif;
        margin: 20px;
        text-align: center;
        }
        .btn {
        padding: 6px 14px;
        margin: 4px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        }

        /* Boutons principaux en bleu */
        .btn-primary {
          background-color: #007BFF;
          color: white;
        }
        .btn-primary:hover {
          background-color: #0056b3;
        }

        /* Boutons secondaires en gris */
        .btn-secondary {
          background-color: #ddd;
          color: #000;
        }
        .btn-secondary:hover {
          background-color: #bbb;
        }

  input[type="text"] {
    padding: 6px;
    text-align: center;
    border: 1px solid #aaa;
    border-radius: 5px;
  }
  #quizZone {
    margin-top: 20px;
  }
  #scoreZone {
    font-weight: bold;
    margin: 10px 0;
  }
  #questionChinese {
    font-size: 2em;
    margin-bottom: 10px;
  }
  #historyZone {
    margin-top: 20px;
    display: none;
    max-height: 250px;
    overflow-y: auto;
    border-top: 2px solid #ccc;
    padding-top: 10px;
  }
  #historyTable {
    border-collapse: collapse;
    margin: 0 auto;
    width: 90%;
  }
  #historyTable th, #historyTable td {
    border: 1px solid #888;
    padding: 4px 8px;
  }
  #responseRow {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
  }
</style>
</head>
<body>

<h2>üìò Quiz chinois</h2>

<input type="file" id="fileInput" accept=".csv"><br>

<div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-top:10px;">
  <label><b>S√©parateur :</b></label>
  <input type="text" id="sepInput" value=";" maxlength="1" style="width:40px;">
  <label><b>Guillemet :</b></label>
  <input type="text" id="quoteInput" value='"' maxlength="1" style="width:40px;">
</div>

<div style="margin-top:10px;">
  <label><b>Mode de devinette :</b></label>
  <select id="modeSelect" disabled>
    <option value="1-2">Chinois ‚Üí Pinyin</option>
    <option value="1-3">Chinois ‚Üí Fran√ßais</option>
    <option value="2-3">Pinyin ‚Üí Fran√ßais</option>
    <option value="3-2">Fran√ßais ‚Üí Pinyin</option>
  </select>
  <button id="startBtn" class="btn btn-primary" disabled>D√©marrer le quiz</button>
</div>

<div id="scoreZone">
  Score : <span id="scoreValue">0</span> /
  <span id="totalValue">0</span>
  (<span id="percentValue">0</span>%)
</div>


<div id="quizZone"></div>

<div id="historyZone">
  <h3>üïò Historique des 10 derni√®res questions</h3>
  <table id="historyTable">
    <thead>
      <tr><th>Chinois</th><th>Pinyin</th><th>Fran√ßais</th><th>Typed</th><th>Time</th><th>Ok</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let data = [];
let weights = [];
let currentIndex = 0;
let score = 0;
let history = [];
let totalTries = 0; // nombre total de tentatives

function escapeHtml(text) {
  if (typeof text !== "string") return text;
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}


// --- Normalisation
function normalize(str) {
  return str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[‚Äô'‚Äò]/g, "'")
    .replace(/[^a-zA-Z0-9\u4e00-\u9fff']/g, "")
    .toLowerCase()
    .trim();
}

// --- Parser CSV simple
function parseCSV(text, separator = ";", quoteChar = '"') {
  const rows = [];
  let current = "";
  let insideQuotes = false;
  let row = [];

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === quoteChar) {
      if (insideQuotes && text[i + 1] === quoteChar) {
        current += quoteChar; i++;
      } else {
        insideQuotes = !insideQuotes;
      }
    } else if (c === separator && !insideQuotes) {
      row.push(current); current = "";
    } else if ((c === "\n" || c === "\r") && !insideQuotes) {
      if (current || row.length > 0) {
        row.push(current);
        rows.push(row);
        row = [];
        current = "";
      }
    } else {
      current += c;
    }
  }
  if (current || row.length > 0) {
    row.push(current);
    rows.push(row);
  }
  return rows;
}

// --- Lecture CSV
document.getElementById("fileInput").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();

  reader.onload = function(ev) {
    const text = ev.target.result;
    const separator = document.getElementById("sepInput").value || ";";
    const quoteChar = document.getElementById("quoteInput").value || '"';
    let rows;
    try {
      rows = parseCSV(text, separator, quoteChar);
    } catch (err) {
      alert("‚ö†Ô∏è Erreur lecture CSV : " + err.message);
      resetInterface();
      return;
    }

    if (!rows || rows.length < 2 || rows[0].length < 3) {
      alert("‚ö†Ô∏è Fichier invalide : au moins 3 colonnes requises.");
      resetInterface();
      return;
    }

    data = rows.slice(1);
    weights = new Array(data.length).fill(1);
    score = 0;
    document.getElementById("scoreValue").textContent = score;
    document.getElementById("modeSelect").disabled = false;
    document.getElementById("startBtn").disabled = false;
    document.getElementById("quizZone").innerHTML = "";
    document.getElementById("historyZone").style.display = "none";
  };

  reader.onerror = function() {
    alert("‚ö†Ô∏è Impossible de lire le fichier.");
    resetInterface();
  };

  reader.readAsText(file, "utf-8");
});

function resetInterface() {
  document.getElementById("fileInput").value = "";
  data = [];
  weights = [];
  document.getElementById("modeSelect").disabled = true;
  document.getElementById("startBtn").disabled = true;
  document.getElementById("quizZone").innerHTML = "";
  document.getElementById("historyZone").style.display = "none";
}

// --- D√©marrer le quiz
document.getElementById("startBtn").addEventListener("click", function() {
  score = 0;
  history = [];
  document.getElementById("scoreValue").textContent = score;
  document.getElementById("historyZone").style.display = "none";
  showQuestion();
});

// --- Afficher une question
function showQuestion() {
  const quizZone = document.getElementById("quizZone");
  quizZone.innerHTML = "";

  // Tirage pond√©r√©
  const totalWeight = weights.reduce((a,b) => a + b, 0);
  let r = Math.random() * totalWeight;
  for (let i = 0; i < weights.length; i++) {
    r -= weights[i];
    if (r <= 0) { currentIndex = i; break; }
  }

  const mode = document.getElementById("modeSelect").value;
  const [fromCol, toCol] = mode.split("-").map(x => parseInt(x,10) - 1);
  const question = data[currentIndex][fromCol];

  const questionDiv = document.createElement("div");
  questionDiv.id = "questionChinese";
  questionDiv.innerHTML = fromCol === 0 ? `<b>${question}</b>` : `${question}`;
  quizZone.appendChild(questionDiv);

  const responseRow = document.createElement("div");
  responseRow.id = "responseRow";

  const input = document.createElement("input");
  input.type = "text";
  input.id = "answerInput";
  input.placeholder = "Votre r√©ponse...";

  input.addEventListener("input", function() {
  const mode = document.getElementById("modeSelect").value;
  const [, toCol] = mode.split("-").map(x => parseInt(x,10) - 1);
  let expected = data[currentIndex][toCol].trim();

  if (toCol === 2) {
    expected = expected.replace(/^\s*\d+[\.\)]\s*/, "");
    const semi = expected.indexOf(";");
    if (semi !== -1) expected = expected.slice(0, semi).trim();
  }

  const user = input.value;
  const normalizedExpected = normalize(expected);
  const normalizedUser = normalize(user);

  let allGood = true;
  for (let i = 0; i < normalizedUser.length; i++) {
    if (normalizedUser[i] !== normalizedExpected[i]) {
      allGood = false;
      break;
    }
  }

  if (normalizedUser.length === 0) {
    input.style.backgroundColor = "white";
  } else if (allGood) {
    input.style.backgroundColor = "#c7f9cc"; // vert clair
  } else {
    input.style.backgroundColor = "#f9cccc"; // rouge clair
  }
});

  const checkBtn = document.createElement("button");
  checkBtn.className = "btn btn-primary";
  checkBtn.textContent = "V√©rifier";

  responseRow.appendChild(input);
  responseRow.appendChild(checkBtn);
  quizZone.appendChild(responseRow);

  const buttonZone = document.createElement("div");
  const dictBtn = document.createElement("button");
  dictBtn.className = "btn btn-secondary";
  dictBtn.textContent = "üîç Frdic";
  dictBtn.style.display = fromCol === 0 ? "inline-block" : "none";

  dictBtn.addEventListener("click", () => {
    const chinese = data[currentIndex][0];
    const url = `https://www.frdic.com/dicts/fr/${encodeURIComponent(chinese)}`;
    window.open(url, "_blank");
  });

  const histBtn = document.createElement("button");
  histBtn.className = "btn btn-secondary";
  histBtn.textContent = "üïò Historique";
  // histBtn.addEventListener("click", showHistory);
  histBtn.addEventListener("click", toggleHistory);

  buttonZone.appendChild(dictBtn);
  buttonZone.appendChild(histBtn);
  quizZone.appendChild(buttonZone);

  const feedbackDiv = document.createElement("div");
  feedbackDiv.style.marginTop = "10px";
  quizZone.appendChild(feedbackDiv);

  checkBtn.addEventListener("click", function() {
    const userAnswer = input.value.trim();
    let expected = data[currentIndex][toCol].trim();

    if (toCol === 2) {
      expected = expected.replace(/^\s*\d+[\.\)]\s*/, "");
      const semi = expected.indexOf(";");
      if (semi !== -1) expected = expected.slice(0, semi).trim();
    }

    totalTries++;
    if (normalize(userAnswer) === normalize(expected)) {
      feedbackDiv.innerHTML = `‚úÖ Correct ! ${data[currentIndex][0]} ; ${data[currentIndex][1]} ; ${data[currentIndex][2]}`;
      weights[currentIndex] = Math.max(1, weights[currentIndex] * 0.5);
      score++;
      correct = true;
    } else {
      feedbackDiv.innerHTML = `‚ùå Faux. R√©ponse attendue : ${expected} ;  ${data[currentIndex][2]}`;
      weights[currentIndex] *= 1.5;
      correct = false;
    }
    updateScoreDisplay();
    saveProgress();

    // history.unshift([...data[currentIndex]]);
    history.unshift({
    chinois: data[currentIndex][0],
    pinyin: data[currentIndex][1],
    Fran√ßais: data[currentIndex][2],
    typed: userAnswer,
    time: new Date().toLocaleTimeString(),
    ok: correct
    });
    if (history.length > 10) history.pop();

    setTimeout(showQuestion, 5000);
  });
}

function updateScoreDisplay() {
  document.getElementById("scoreValue").textContent = score;
  document.getElementById("totalValue").textContent = totalTries;
  const percent = totalTries > 0 ? Math.round((score / totalTries) * 100) : 0;
  document.getElementById("percentValue").textContent = percent;
}

// Sauvegarde dans localStorage
function saveProgress() {
  const mode = document.getElementById("modeSelect").value;
  const saveData = {
    mode,
    score,
    totalTries,
    weights
  };
  localStorage.setItem("quizChineseProgress", JSON.stringify(saveData));
}

// Chargement au d√©marrage
function loadProgress() {
  const saved = localStorage.getItem("quizChineseProgress");
  if (!saved) return;
  try {
    const parsed = JSON.parse(saved);
    document.getElementById("modeSelect").value = parsed.mode || "1-2";
    score = parsed.score || 0;
    totalTries = parsed.totalTries || 0;
    weights = parsed.weights || weights;
    updateScoreDisplay();
  } catch (err) {
    console.warn("‚ö†Ô∏è Donn√©es sauvegard√©es corrompues :", err);
  }
}


// --- Historique
function showHistory() {
  const zone = document.getElementById("historyZone");
  if (history.length === 0) {
    zone.style.display = "block";
    zone.innerHTML = "<tr><td colspan='3'><i>Aucune question encore.</i></td></tr>";
    return;
  }
    let html = `
    <table>
      <thead>
        <tr>
          <th>Chinois</th>
          <th>Pinyin</th>
          <th>Fran√ßais</th>
          <th>Typed</th>
          <th>Time</th>
          <th>Ok</th>
        </tr>
      </thead>
      <tbody>
  `;
  history.forEach(h => {
   const color = h.ok ? 'green' : 'red';
   const icon = h.ok ? 'üü¢' : 'üî¥';
   html += `
       <tr style="color:${color}">
        <td>${escapeHtml(h.chinois)}</td>
        <td>${escapeHtml(h.pinyin)}</td>
        <td>${escapeHtml(h.Fran√ßais)}</td>
        <td>${escapeHtml(h.typed || '')}</td>
        <td>${escapeHtml(h.time || '')}</td>
        <td style="text-align:center;">${icon}</td>
      </tr>`;
  });
  html += "</tbody></table>";
  zone.innerHTML = html;
  zone.style.display = "block";
}

let historyVisible = false;

function toggleHistory() {
  const zone = document.getElementById("historyZone");
  if (!zone) return;

  if (historyVisible) {
    zone.innerHTML = "";
  } else {
    showHistory();
  }

  historyVisible = !historyVisible; // inverse l‚Äô√©tat
}

function renderHistory(){
  const div = document.getElementById("historyZone");
  // si tu veux garder l'en-t√™te, adapte ; ici on r√©√©crit le contenu
  if (history.length === 0) {
    div.innerHTML = "<h4>Historique</h4><div><i>Aucune question.</i></div>";
    return;
  }
  let html = "<h4>Historique</h4>\
  <table style='margin:0 auto;'><thead>\
  <tr><th>Chinois</th>\
  <th>Pinyin</th>\
  <th>Fran√ßais</th>\
  <th>Tap√©</th>\
  <th>R√©sultat</th>\
  </tr></thead><tbody>";
  history.forEach(h => {
    html += `<tr>
      <td>${escapeHtml(h.c1)}</td>
      <td>${escapeHtml(h.c2)}</td>
      <td>${escapeHtml(h.c3)}</td>
      //<td>${escapeHtml(h.typed)}</td>
      //<td style="color:${h.ok?'green':'red'}">${h.ok? 'OK':'KO'}</td>
    </tr>`;
  });
  html += "</tbody></table>";
  div.innerHTML = html;
}


// Charger la progression pr√©c√©dente au d√©marrage
window.addEventListener("load", loadProgress);

</script>
</body>
</html>
